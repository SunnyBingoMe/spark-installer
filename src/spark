#!/bin/bash

source ~/.pam_environment
spark="spark-0.8.1-incubating"
wget http://d3kbcqa49mib13.cloudfront.net/spark-0.8.1-incubating.tgz -P \
$DOWNLOAD_DIR
tar -xzf $DOWNLOAD_DIR/spark-0.8.1-incubating.tgz -C $DOWNLOAD_DIR
# Now build Spark
cp -R $DOWNLOAD_DIR/$spark $SPARK_DIR

mv $SPARK_DIR/conf/spark-env.sh.template $SPARK_DIR/conf/spark-env.sh
echo "export SCALA_HOME=$SCALA_DIR" | tee -a $SPARK_DIR/conf/spark-env.sh
echo "export export SPARK_WORKER_MEMORY=2g" | tee -a $SPARK_DIR/conf/spark-env.sh

#set hadoop version in spark build
sed -i 's|1.0.4|2.2.0|' $SPARK_DIR/project/SparkBuild.scala

sed -i 's|DEFAULT_YARN = false|DEFAULT_YARN = true|' $SPARK_DIR/project/SparkBuild.scala

cd $SPARK_DIR
SPARK_HADOOP_VERSION=2.2.0 SPARK_YARN=true ./sbt/sbt assembly
cp conf/log4j.properties.template conf/log4j.properties

echo "*********** Spark Done ************"
